<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Report</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <div class="container">
        <h1>Scan Report & Forensics</h1>
        <p class="subtitle">File: <span id="filename">Unknown</span></p>

        <div class="glass-card verdict-banner" id="verdict-banner">
            <div class="verdict-title" id="verdict-title">VERDICT: ANALYZING...</div>
            <div style="font-size: 0.9rem; margin-top: 5px;" id="verdict-reason">Processing results...</div>
        </div>

        <h3 style="margin-bottom: 1rem;">3-Layer Results Breakdown</h3>
        <div class="breakdown-grid">
            <div class="glass-card stat-box">
                <span class="stat-label">Layer 1: C2PA</span>
                <span class="stat-value" id="layer1-result">--</span>
            </div>
            <div class="glass-card stat-box">
                <span class="stat-label">Layer 2: SynthID</span>
                <span class="stat-value" id="layer2-result">--</span>
            </div>
            <div class="glass-card stat-box">
                <span class="stat-label">Layer 3: AI Model</span>
                <span class="stat-value" id="layer3-result">--</span>
            </div>
        </div>

        <h3 style="margin-bottom: 1rem;">Forensic Log & Detailed Analysis</h3>
        <div class="glass-card forensic-layout" style="padding: 2rem;">
            <div style="text-align: center;">
                <div style="margin-bottom: 10px; color: #ccc;">Final Confidence Score</div>
                <div class="score-circle" id="score-circle">
                    <div class="score-inner" id="score-value">--%</div>
                </div>
                <div style="margin-top: 15px; font-weight: bold;" id="probability-label">Calculating...</div>
            </div>

            <div class="detailed-log" id="detailed-log">
                [LOG] Loading analysis results...
            </div>
        </div>

        <h3 style="margin-bottom: 1rem; margin-top: 2rem;">Forensic Report</h3>
        <div class="glass-card" style="padding: 1.5rem;">
            <button class="btn-glow" id="generate-report-btn" style="margin-bottom: 1rem;">Generate Detailed Report</button>
            <div id="ai-report" class="detailed-log" style="display: none; height: auto; max-height: 400px; white-space: pre-wrap;">
            </div>
        </div>
        
        <br>
        <button class="btn-glow" onclick="location.href='/'">Scan Another File</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resultJson = sessionStorage.getItem('analysisResult');
            if (!resultJson) {
                document.getElementById('verdict-title').textContent = 'NO DATA';
                document.getElementById('verdict-reason').textContent = 'No analysis result found. Please scan an image first.';
                return;
            }

            const result = JSON.parse(resultJson);
            const isAI = result.is_ai_generated;
            const confidence = result.confidence;

            // Update filename
            document.getElementById('filename').textContent = result.filename || 'Unknown';

            // Update verdict banner
            const verdictBanner = document.getElementById('verdict-banner');
            const verdictTitle = document.getElementById('verdict-title');
            const verdictReason = document.getElementById('verdict-reason');

            if (isAI) {
                verdictTitle.textContent = 'VERDICT: AI-GENERATED';
                verdictBanner.style.borderColor = 'var(--neon-red)';
                verdictBanner.style.background = 'rgba(255, 42, 42, 0.1)';
            } else {
                verdictTitle.textContent = 'VERDICT: AUTHENTIC';
                verdictBanner.style.borderColor = 'var(--neon-green)';
                verdictBanner.style.background = 'rgba(0, 255, 136, 0.1)';
                verdictTitle.style.color = 'var(--neon-green)';
            }

            // Determine reason
            const c2pa = result.layers.c2pa;
            if (c2pa && c2pa.c2pa_present) {
                verdictReason.textContent = 'Source: C2PA cryptographic verification (100% confidence)';
            } else {
                verdictReason.textContent = 'Source: AI detection model ensemble analysis';
            }

            // Layer 1: C2PA
            const layer1 = document.getElementById('layer1-result');
            if (c2pa && c2pa.c2pa_present) {
                layer1.textContent = c2pa.ai_generated ? 'AI Declared' : 'Verified';
                layer1.style.color = c2pa.ai_generated ? 'var(--neon-red)' : 'var(--neon-green)';
            } else {
                layer1.textContent = 'Not Found';
                layer1.style.color = '#888';
            }

            // Layer 2: SynthID
            const layer2 = document.getElementById('layer2-result');
            const synthid = result.layers.synthid;
            if (synthid && synthid.status === 'skipped') {
                layer2.textContent = 'Skipped';
                layer2.style.color = '#888';
            } else {
                layer2.textContent = 'N/A';
            }

            // Layer 3: AI Model
            const layer3 = document.getElementById('layer3-result');
            const aiModel = result.layers.ai_model;
            if (aiModel && aiModel.status === 'complete') {
                const conf = aiModel.confidence.toFixed(1);
                layer3.textContent = `${conf}% ${aiModel.label}`;
                layer3.style.color = aiModel.label === 'AI Image' ? 'var(--neon-red)' : 'var(--neon-green)';
            } else if (aiModel && aiModel.status === 'skipped') {
                layer3.textContent = 'Skipped';
                layer3.style.color = '#888';
            } else {
                layer3.textContent = 'Error';
                layer3.style.color = '#888';
            }

            // Confidence score
            document.getElementById('score-value').textContent = confidence.toFixed(1) + '%';
            const scoreCircle = document.getElementById('score-circle');
            scoreCircle.style.background = `conic-gradient(${isAI ? 'var(--neon-red)' : 'var(--neon-green)'} ${confidence}%, transparent 0)`;

            // Probability label
            const probLabel = document.getElementById('probability-label');
            let probText = 'Low';
            if (confidence > 80) probText = 'Very High';
            else if (confidence > 60) probText = 'High';
            else if (confidence > 40) probText = 'Medium';
            probLabel.textContent = `Probability: ${probText}`;
            probLabel.style.color = isAI ? 'var(--neon-red)' : 'var(--neon-green)';

            // Detailed log
            const log = document.getElementById('detailed-log');
            let logHtml = `[LOG] Analysis completed at ${new Date().toLocaleTimeString()}.<br>`;
            
            if (c2pa) {
                if (c2pa.c2pa_present) {
                    logHtml += `[LAYER 1] C2PA metadata FOUND. Issuer: ${c2pa.issuer || 'Unknown'}. Valid: ${c2pa.valid ? 'YES' : 'NO'}.<br>`;
                    logHtml += `[LAYER 1] AI Generated flag in manifest: ${c2pa.ai_generated ? 'YES' : 'NO'}.<br>`;
                } else {
                    logHtml += `[LAYER 1] C2PA check complete. No cryptographic signature found.<br>`;
                }
            }

            if (synthid) {
                logHtml += `[LAYER 2] SynthID: ${synthid.reason || synthid.status}.<br>`;
            }

            if (aiModel && aiModel.status === 'complete') {
                logHtml += `[LAYER 3] AI Model inference complete. Label: ${aiModel.label}. Confidence: ${aiModel.confidence.toFixed(2)}%.<br>`;
            } else if (aiModel && aiModel.status === 'skipped') {
                logHtml += `[LAYER 3] AI Model skipped: ${aiModel.reason}.<br>`;
            }

            logHtml += `[CONCLUSION] Final verdict: ${result.final_verdict} with ${confidence.toFixed(1)}% confidence.`;
            log.innerHTML = logHtml;

            // Setup Generate Report button
            const generateBtn = document.getElementById('generate-report-btn');
            const aiReportDiv = document.getElementById('ai-report');
            
            generateBtn.addEventListener('click', async function() {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
                aiReportDiv.style.display = 'block';
                aiReportDiv.innerHTML = 'Generating detailed forensic report...';

                try {
                    const response = await fetch('/api/forensic-report', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: resultJson
                    });

                    const report = await response.json();

                    if (report.success) {
                        // Convert markdown to HTML-friendly format
                        aiReportDiv.innerHTML = formatMarkdown(report.enhanced_report);
                        generateBtn.textContent = 'Report Generated';
                    } else {
                        // Show error
                        aiReportDiv.innerHTML = `<span style="color: var(--neon-red);">Error: ${report.error}</span>`;
                        generateBtn.textContent = 'Error';
                    }
                } catch (error) {
                    aiReportDiv.innerHTML = `Network Error: ${error.message}`;
                    generateBtn.textContent = 'Error';
                }
            });

            // Clear session storage after setting up button
            sessionStorage.removeItem('analysisResult');
        });

        function formatMarkdown(text) {
            // Basic markdown to HTML conversion
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/^### (.+)$/gm, '<h4 style="color: var(--neon-blue); margin-top: 1rem;">$1</h4>')
                .replace(/^## (.+)$/gm, '<h3 style="color: var(--neon-blue); margin-top: 1.5rem;">$1</h3>')
                .replace(/^# (.+)$/gm, '<h2 style="color: var(--neon-blue); margin-top: 1.5rem;">$1</h2>')
                .replace(/^- (.+)$/gm, 'â€¢ $1')
                .replace(/\n/g, '<br>');
        }
    </script>

</body>
</html>